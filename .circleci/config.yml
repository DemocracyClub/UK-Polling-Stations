
version: 2.1



orbs:
  node: circleci/node@5.0.2

jobs:
  build:
    docker:
      - image: cimg/python:3.10.8-browsers
        environment:
          CIRCLECI: true
          PGHOST: 127.0.0.1
      - image: cimg/postgres:14.5-postgis
        environment:
          POSTGRES_USER: postgres
          POSTGRES_DB: polling_stations

    working_directory: ~/repo

    steps:
      - checkout

      - restore_cache:
          keys:
            - v2-polling_stations-dependencies-{{ checksum "requirements/base.txt" }}-{{ checksum "requirements/testing.txt" }}
            - v2-polling_stations-dependencies-{{ checksum "package-lock.json" }}
            - polling_stations-dependencies-tidy-5.8.0

      - node/install:
          node-version: '10.19.0'

      - run:
          name: Install node node_modules
          command: npm install
          cache-path: ~/repo/node_modules
          override-ci-command: npm install

      - run:
          name: install dependencies
          command: |
            sudo apt update && sudo apt install -y gdal-bin
            python -m venv .venv
            . .venv/bin/activate
            pip install --upgrade pip
            pip install wheel
            pip install coveralls
            pip install -r requirements/testing.txt
            playwright install

      - run:
          name: Install HTML Tidy
          command: |
            mkdir -p ~/tidy
            wget --directory-prefix /home/circleci/tidy https://github.com/htacg/tidy-html5/releases/download/5.8.0/tidy-5.8.0-Linux-64bit.deb && sudo dpkg -i /home/circleci/tidy/tidy-5.8.0-Linux-64bit.deb

      - save_cache:
          paths:
            - ./.venv
            - /home/circleci/.cache/ms-playwright
          key: v2-polling_stations-dependencies-{{ checksum "requirements/base.txt" }}-{{ checksum "requirements/testing.txt" }}

      - save_cache:
          paths:
            - ./node_modules
          key: v2-polling_stations-dependencies-{{ checksum "package-lock.json" }}

      - save_cache:
          paths:
            - ./home/circleci/tidy
          key: polling_stations-dependencies-tidy-5.8.0


      - run:
          name: Print versions
          command: |
            . .venv/bin/activate
            python --version
            python manage.py --version

      - run:
          name: Pre-test checks
          command: |
            . .venv/bin/activate
            black --check .
            pip check
            python manage.py check
            python manage.py makemigrations --check

      - run:
          name: Pytest
          command: |
            . .venv/bin/activate
            python manage.py collectstatic --no-input
            pytest --flakes --cov-report= --cov=polling_stations

      - run:
          name: Submit coverage
          command: |
            . .venv/bin/activate
            coveralls
